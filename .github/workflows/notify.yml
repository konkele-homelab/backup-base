name: Notify Downstream

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: 'Optional upstream tag to notify'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  notify:
    name: Notify Downstream Repositories
    runs-on: [self-hosted]
    continue-on-error: true
    env:
      ORG: ${{ github.repository_owner }}
      TOPIC_FILTER: backup-utility
      EVENT_NAME: base_image_updated
      TOKEN: ${{ secrets.REPO_DISPATCH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine upstream tag
        id: get_tag
        run: |
          # Use workflow input if provided
          if [[ -n "${{ github.event.inputs.upstream_tag }}" ]]; then
            FULL="${{ github.event.inputs.upstream_tag }}"
          else
            # Fetch latest tag from the current repo
            git fetch --tags
            tag=$(git tag --sort=-creatordate | head -n1)
            if [[ -z "$tag" ]]; then
              echo "No tags found, defaulting to 0.1.0"
              tag="0.1.0"
            fi
            FULL="${tag#v}"
          fi
          echo "Using upstream tag: $FULL"
          echo "FULL=$FULL" >> "$GITHUB_ENV"

      - name: Notify downstream repositories
        id: notify
        run: |
          repos=()
          page=1

          # Loop through org repos with pagination
          while : ; do
            response=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=100&page=$page")

            count=$(echo "$response" | jq length)
            [[ "$count" -eq 0 ]] && break

            matched=$(echo "$response" | jq -r --arg topic "$TOPIC_FILTER" \
              '.[] | select(.topics | index($topic)) | .full_name')

            if [[ -n "$matched" ]]; then
              while read -r r; do
                repos+=("$r")
              done <<< "$matched"
            fi

            ((page++))
          done

          # Convert array to JSON for GitHub Actions output
          json_array=$(printf '%s\n' "${repos[@]}" | jq -R . | jq -s -c .)
          echo "repos=$json_array" >> "$GITHUB_OUTPUT"

          # Trigger repository_dispatch for each downstream repo
          for repo in "${repos[@]}"; do
            echo "Notifying $repo with upstream tag $FULL..."
            curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/${repo}/dispatches" \
              -d "{\"event_type\": \"${EVENT_NAME}\", \"client_payload\": {\"upstream_tag\": \"${FULL}\"}}"
          done
