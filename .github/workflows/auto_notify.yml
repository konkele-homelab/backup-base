name: Auto-Notify Downstream Repos

on:
  push:
    branches:
      - main
    paths:
      - Dockerfile
      - "**/*.sh"

  workflow_dispatch: {}

jobs:
  notify:
    runs-on: [self-hosted]
    env:
      ORG: konkele-homelab
      TOPIC_FILTER: backup-utility
      EVENT_NAME: base_image_updated

    steps:
      - name: List repositories in org
        id: list
        env:
          TOKEN: ${{ secrets.REPO_DISPATCH_TOKEN }}
        run: |
          echo "Fetching repositories from org: $ORG"

          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/orgs/$ORG/repos?per_page=200" \
            > repos.json

          echo "Filtering for repos with topic: $TOPIC_FILTER"

          # Extract repo names that contain the topic
          matched=$(jq -r \
            --arg topic "$TOPIC_FILTER" \
            '.[] | select(.topics | index($topic)) | .full_name' \
            repos.json)

          echo "matched<<EOF" >> $GITHUB_OUTPUT
          echo "$matched" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger repository_dispatch on downstream repos
        env:
          TOKEN: ${{ secrets.REPO_DISPATCH_TOKEN }}
          EVENT_NAME: ${{ env.EVENT_NAME }}
        run: |
          echo "Repos to notify:"
          echo "${{ steps.list.outputs.matched }}"

          for repo in ${{ steps.list.outputs.matched }}; do
            echo "Notifying $repo ..."

            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token ${TOKEN}" \
              https://api.github.com/repos/${repo}/dispatches \
              -d "{\"event_type\": \"${EVENT_NAME}\"}"

          done
